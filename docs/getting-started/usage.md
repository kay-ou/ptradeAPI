# Ptrade 使用说明

本文档详细介绍了 Ptrade 平台的策略业务流程、核心函数、运行机制及支持的业务类型，帮助您深入理解并高效使用平台。

## 业务流程框架

Ptrade 量化引擎以**事件驱动**为核心，通过一系列预定义的函数（事件处理器）来构建和执行策略。一个完整的交易日中，策略的生命周期主要由以下几个核心事件构成：


1.  **`initialize(context)` (初始化)**: 策略启动时执行一次，用于全局设置。
2.  **`before_trading_start(context, data)` (盘前处理)**: 每个交易日开盘前执行一次。
3.  **`handle_data(context, data)` (主逻辑)**: 盘中按设定的频率（日/分钟）循环执行。
4.  **`after_trading_end(context, data)` (盘后处理)**: 每个交易日收盘后执行一次。

此外，平台还支持更灵活的事件处理器：
-   **`tick_data(context, data)`**: 用于处理 Tick 级别的逻辑。
-   **`run_daily()` / `run_interval()`**: 定时任务，可按日或自定义秒级间隔执行。
-   **`on_order_response()` / `on_trade_response()`**: 委托和成交回报的实时推送事件。

---

## 核心函数详解

### `initialize(context)`

-   **时机**: 策略启动时（回测或交易开始时）调用一次。
-   **作用**: 设置策略的全局配置和初始化变量。这是唯二的**必选函数**之一。
-   **常用操作**:
    -   设置股票池 (`set_universe`)。
    -   设置基准 (`set_benchmark`)。
    -   设置手续费和滑点 (`set_commission`, `set_slippage`)。
    -   初始化全局变量 `g` 中的自定义参数。
    -   注册定时任务 (`run_daily`, `run_interval`)。

### `before_trading_start(context, data)`

-   **时机**: 每个交易日开盘前调用一次（交易模式下默认 9:10，回测模式下 8:30）。
-   **作用**: 进行每日开盘前的准备工作。
-   **常用操作**:
    -   查询当日财务数据、指数成分股等。
    -   根据最新信息调整当日的交易计划。
    -   重置每日状态变量。
-   **注意**: 在交易模式下，9:10 前调用实时行情接口可能获取到旧数据。

### `handle_data(context, data)`

-   **时机**: 盘中根据策略设置的频率（日或分钟）循环调用。
-   **作用**: 实现策略最核心的交易逻辑。这是唯二的**必选函数**之一。
-   **运行频率**:
    -   **日线**: 每天 15:00 (回测) 或 14:50 (交易，可配置) 调用一次。
    -   **分钟**: 每个分钟 K 线结束后调用一次。
-   **常用操作**:
    -   获取行情数据 (`data` 对象或 `get_history`)。
    -   进行技术指标计算和逻辑判断。
    -   执行下单操作 (`order`, `order_target` 等)。

### `after_trading_end(context, data)`

-   **时机**: 每个交易日收盘后调用一次（通常为 15:30）。
-   **作用**: 进行每日收盘后的数据分析、总结和清理工作。
-   **常用操作**:
    -   记录当日交易总结。
    -   进行策略表现分析。
    -   为第二天的交易准备数据。

---

## 策略运行与业务支持

### 策略运行周期与时间

| 频率 | 调用函数 | 回测运行时间 | 交易运行时间 |
|---|---|---|---|
| **日线** | `handle_data` | 15:00 | 14:50 (默认) |
| **分钟** | `handle_data` | 09:31 - 15:00 | 09:30 - 14:59 |
| **Tick** | `tick_data` / `run_interval` | 不支持 | 09:30 - 14:59 (最小间隔3秒) |

-   **盘前 (09:30前)**: `before_trading_start` 执行。
-   **盘中 (09:30-15:00)**: `handle_data`, `tick_data`, `run_interval` 执行。
-   **盘后 (15:00后)**: `after_trading_end` 执行。

### 支持的业务类型

| 业务类型 | 回测支持 | 交易支持 | 单位 |
|---|:---:|:---:|------|
| 普通股票 | ✅ | ✅ | 股 |
| 可转债 (T+0) | ✅ | ✅ | 张 |
| 融资融券 | ✅ | ✅ | 股 |
| 期货 | ✅ | ✅ | 手 |
| ETF 基金 | ✅ | ✅ | 份/股 |
| LOF 基金 | ✅ | ✅ | 股 |
| ETF 申赎 | ❌ | ✅ | 份 |
| 国债逆回购 | ❌ | ✅ | 份 |
| 期权 | ❌ | ✅ | 张 |

---

## 下一步

-   **[快速入门](quick-start.md)**: 学习如何编写您的第一个策略。
-   **[API 参考](../api-reference/)**: 查看所有函数的详细说明。
-   **[策略示例](examples.md)**: 从丰富的示例中寻找灵感。
